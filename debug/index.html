<!-- AuroraVM Debugger GUI -->
<html>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link rel="stylesheet" type="text/css" href="./style.css" charset="utf-8"/>
<title>AVM Debugger</title>

</head>
<body>

<div class="mainbox">
    <!--标题-->
    <header>
        <div class="title">
            <img src="./icon.png" style="float: left; position: relative; height: 55px; left: -8px;">
            <div style="line-height: 55px;">
                <span style="font-size: 25px; color:#666666;">AnimacVM</span> <span style="font-size: 25px; color:#dddddd;">Debugger</span>
                <i style="color:#cccccc; font-size: 13px;">v0 alpha</i>
                <div style="float: right; right: 0; margin-top: 18px;">
                    <a href="https://github.com/bd4sur/Animac" target="_blank"><img alt="GitHub stars" src="https://img.shields.io/github/stars/bd4sur/Animac?style=social"></a>
                </div>
            </div>
        </div>
    </header>

    <hr>

    <div class="debugger">

        <div style="margin: 15px 0;">
            <button id="execute" class="btn-start">▶ 启动</button>
            <button id="reset"  class="btn-stop">↺ 复位</button>
            <button id="step"  class="btn-common">▷ 步进(F8)</button>
            <button id="stepbystep"  class="btn-common">▷ 连续步进</button>
        </div>

        <div class="console"><pre id="output">Animac Debugger
</pre>
        </div>

        <div class="col_container">
            <div class="ilcode_column">
                <div class="col_header">中间语言指令序列</div>
                <div id="ilcode"></div>
            </div>
            <div class="fstack_column">
                <div class="col_header">函数调用栈</div>
                <div id="fstack"></div>
            </div>
            <div class="opstack_column">
                <div class="col_header">操作数栈</div>
                <div id="opstack"></div>
            </div>
            <div class="heap_column">
                <div class="col_header">存储（堆）</div>
                <div id="heap_map"></div>
                <div id="heap_obj_info"></div>
            </div>
        </div>

    </div>

<script src="./jquery.min.js"></script>
<script>

function esc(s) {
    return String(s).replace(/&/gi, "&amp;");
}

function render(res) {
    let process = res.process;
    let heap_data = process.heap.data;
    let FSTACK = process.FSTACK;
    let OPSTACK = process.OPSTACK;
    let instructions = process.instructions;

    // Console
    $("#output").html(res.outputBuffer);

    // 渲染IL代码
    let html = new Array();
    for(let i = 0; i < instructions.length; i++) {
        let color = "color:#000000;background-color:#ffffff;";
        if(process.PC === i) color = "color:#ff0000;background-color:#cbeeff;";
        html.push(`<p class="ilcode" id="ilcode${i}" style="${color}"><span class="lineNum">${i}</span>${instructions[i]}</p>`);
    }
    $('#ilcode').html(html.join(""));

    // 渲染FSTACK
    html = new Array();
    for(let i = FSTACK.length - 1; i >= 0; i--) {
        html.push(`
        <span class="lineNum">${i}</span><span class="fstack_closure">${esc(FSTACK[i].closureHandle)}</span><span class="fstack_retaddr">${FSTACK[i].returnTargetAddress}</span><br>`);
    }
    $('#fstack').html(html.join(""));

    // 渲染OPSTACK
    html = new Array();
    for(let i = OPSTACK.length - 1; i >= 0; i--) {
        html.push(`<span class="lineNum">${i}</span>${esc(OPSTACK[i])}<br>`);
    }
    $('#opstack').html(html.join(""));

    // 渲染闭包
    html = new Array();
    for(let hd in heap_data) {
        let property = "";
        if((process.heap.metadata[hd])[0] === "S") {
            property = ` heap_obj_static`;
        }
        else if(heap_data[hd].type === "CLOSURE") {
            if(process.currentClosureHandle === hd) {
                property = ` heap_obj_closure heap_obj_closure_current`;
                renderHeapObjectInfo(hd, heap_data[hd]);
            }
            else {
                property = ` heap_obj_closure`;
            }
        }
        else if(process.heap.data[hd].type === "QUOTE") {
            property = ` heap_obj_quote`;
        }
        else if(process.heap.data[hd].type === "CONTINUATION") {
            property = ` heap_obj_continuation`;
        }

        html.push(`<div class="heap_obj_box${property}" data-hd="${esc(hd)}">${esc(JSON.stringify(heap_data[hd]))}</div>`);
    }
    $('#heap_map').html(html.join(""));
}

function renderHeapObjectInfo(hd, info) {
    if(info.type === "CLOSURE") {
        let variableLine = new Array();
        for(let bound in info.boundVariables) {
            let color = "";
            if((info.dirtyFlag)[bound] === true) color = ` style="color: red; font-weight: bold;"`;
            variableLine.push(`<tr class="bound_var"><td class="var_name"${color}>${esc(bound)}</td><td class="var_value"${color}>${esc((info.boundVariables)[bound])}</td></tr>`);
        }
        for(let free in info.freeVariables) {
            variableLine.push(`<tr class="free_var"><td class="var_name">${esc(free)}</td><td class="var_value">${esc((info.freeVariables)[free])}</td></tr>`);
        }

        $("#heap_obj_info").html(`
        <div>${esc(hd)}(${info.instructionAddress})</div>
        <div>Parent: ${esc(info.parent)}</div>
        <table class="closure_var_table">${variableLine.join("")}</table>`);
    }
    else if(info.type === "QUOTE") {
        $("#heap_obj_info").html(`
        <div>${esc(hd)}</div>
        <div>Parent: ${esc(info.parent)}</div>
        <div>${esc(info.children)}</div>`);
    }
    else if(info.type === "CONTINUATION") {
        $("#heap_obj_info").html(`
        <div>${esc(hd)}</div>
        <div>partialEnvironmentJson: ${esc(info.partialEnvironmentJson)}</div>
        <div>contReturnTargetLable: ${esc(info.contReturnTargetLable)}</div>`);
    }
}

function SendDebugRequest(action) {
    $.ajax({
        type: "GET",
        url: `./${action}`,
        success: (data)=> {
            render(data);
            $(".heap_obj_box").each((i,e)=>{
                $(e).click((event)=> {
                    let hd = $(e).attr("data-hd");
                    let info = JSON.parse($(e).text());
                    renderHeapObjectInfo(hd, info);
                });
            });
        },
        error: ()=> {
            console.error(`failed`);
        }
    });
}

let clock = 0;
let state = "paused";

function pause() {
    $("#stepbystep").html("▷ 连续步进");
    state = "paused";
    clearInterval(clock);
}

$("#execute").click(()=>{
    pause();
    SendDebugRequest("execute");
});
$("#step").click(()=>{
    pause();
    SendDebugRequest("step");
});
$("#stepbystep").click(()=>{
    if(state === "paused") {
        $("#stepbystep").html("|| 暂停");
        state = "running";
        clock = setInterval(()=>{
            SendDebugRequest("step");
        }, 0);
    }
    else if(state === "running") {
        pause();
    }
});

$("#reset").click(()=>{
    pause();
    SendDebugRequest("reset");
});

document.onkeydown = (event)=>{
    if(event && event.keyCode === 119){ // F8
        pause();
        SendDebugRequest("step");
    }
}; 

</script>

</body>
</html>
