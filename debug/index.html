<!-- AuroraVM Debugger GUI -->
<html>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link rel="stylesheet" type="text/css" href="./style.css" charset="utf-8"/>
<title>AVM Debugger</title>

</head>
<body>

<div class="mainbox">
    <!--标题-->
    <header>
        <div class="title">
            <img src="./icon.png" style="float: left; position: relative; height: 55px; left: -8px;">
            <div style="line-height: 55px;">
                <span style="font-size: 25px; color:#666666;">AnimacVM</span> <span style="font-size: 25px; color:#dddddd;">Debugger</span>
                <i style="color:#cccccc; font-size: 13px;">v0 alpha</i>
                <div style="float: right; right: 0; margin-top: 18px;">
                    <a href="https://github.com/bd4sur/Animac" target="_blank"><img alt="GitHub stars" src="https://img.shields.io/github/stars/bd4sur/Animac?style=social"></a>
                </div>
            </div>
        </div>
    </header>

    <hr>

    <div class="debugger">

        <div style="margin: 15px 0;">
            <button id="execute" class="btn-start">▶ 启动</button>
            <button id="reset"  class="btn-stop">↺ 复位</button>
            <button id="step"  class="btn-common">▷ 步进(F10)</button>
            <button id="stepbystep"  class="btn-common">▷ 连续步进</button>
        </div>

        <div class="console"><pre id="output">Animac Debugger
</pre>
        </div>

        <div class="col_container">
            <div class="ilcode_column">
                <div class="col_header">中间语言代码</div>
                <div id="ilcode"></div>
            </div>
            <div class="fstack_column">
                <div class="col_header">函数调用栈</div>
                <div id="fstack"></div>
            </div>
            <div class="opstack_column">
                <div class="col_header">操作数栈</div>
                <div id="opstack"></div>
            </div>
            <div class="heap_column">
                <div class="col_header">存储(<span style="color:#00dddd;">池</span>/<span style="color:#dddd00;">堆</span>)</div>
                <div id="heap"></div>
            </div>
        </div>

    </div>

<script src="./jquery.min.js"></script>
<script>

function render(res) {
    let process = res.process;
    let heap = process.heap.data;
    let FSTACK = process.FSTACK;
    let OPSTACK = process.OPSTACK;
    let instructions = process.instructions;

    function esc(s) {
        return String(s).replace("&", "&amp;");
    }

    // Console
    $("#output").html(res.outputBuffer);

    // 渲染IL代码
    let html = new Array();
    for(let i = 0; i < instructions.length; i++) {
        let color = "color:#000000;background-color:#ffffff;";
        if(process.PC === i) color = "color:#ff0000;background-color:#cbeeff;";
        html.push(`<p class="ilcode" id="ilcode${i}" style="${color}"><span class="lineNum">${i}</span>${instructions[i]}</p>`);
    }
    $('#ilcode').html(html.join(""));

    // 渲染FSTACK
    html = new Array();
    for(let i = FSTACK.length - 1; i > 0; i--) {
        html.push(`
        <span class="lineNum">${i}</span><span class="fstack_closure">${esc(FSTACK[i].closureHandle)}</span><span class="fstack_retaddr">${FSTACK[i].returnTargetAddress}</span><br>`);
    }
    $('#fstack').html(html.join(""));

    // 渲染OPSTACK
    html = new Array();
    for(let i = OPSTACK.length - 1; i > 0; i--) {
        html.push(`<span class="lineNum">${i}</span>${esc(OPSTACK[i])}<br>`);
    }
    $('#opstack').html(html.join(""));

    // 渲染闭包
    html = new Array();
    for(let hd in heap) {
        if(/^\&CLOSURE/gi.test(hd)) {
            let variableLine = new Array();
            for(let bound in heap[hd].boundVariables) {
                // let boundVarFields = bound.split(".");
                let color = "";
                if((heap[hd].dirtyFlag)[bound] === true) color = ` style="color: red; font-weight: bold;"`;
                variableLine.push(`<tr class="hidden bound_var"><td class="var_name"${color}>${esc(bound)}</td><td class="var_value"${color}>${esc((heap[hd].boundVariables)[bound])}</td></tr>`);
            }
            for(let free in heap[hd].freeVariables) {
                // let freeVarFields = free.split(".");
                variableLine.push(`<tr class="hidden free_var"><td class="var_name">${esc(free)}</td><td class="var_value">${esc((heap[hd].freeVariables)[free])}</td></tr>`);
            }

            let currentClosureFlag = "";
            if(hd === process.currentClosureHandle) {
                currentClosureFlag = ` style="color: red; font-weight: bold;"`;
            }
            html.push(`<div class="closure_box">
                <div class="closure_box_header">
                    <span class="closure_handle"${currentClosureFlag}>${esc(hd)}</span> (<span class="closure_iaddr">${heap[hd].instructionAddress}</span>)
                    <span class="closure_parent_handle">上位闭包：${esc(heap[hd].parent)}</span>
                </div>
                <table class="closure_var_table">${variableLine.join("")}</table>
            </div>`);
        }
        else {
            html.push(`<div class="closure_box">${esc(hd)}
                <div class="hidden">${esc(JSON.stringify(heap[hd]))}</div>
                </div>`);
        }
    }
    $('#heap').html(html.join(""));
}

function SendDebugRequest(action) {
    $.ajax({
        type: "GET",
        url: `./${action}`,
        success: (data)=> {
            render(data);
            $(".closure_box").each((i,e)=>{
                $(e).mousedown((event)=> {
                    $(e).find(".hidden").toggle(0);
                });
            });
        },
        error: ()=> {
            console.error(`failed`);
        }
    });
}

let clock = 0;
let state = "paused";

function pause() {
    $("#stepbystep").html("▷ 连续步进");
    state = "paused";
    clearInterval(clock);
}

$("#execute").click(()=>{
    pause();
    SendDebugRequest("execute");
});
$("#step").click(()=>{
    pause();
    SendDebugRequest("step");
});
$("#stepbystep").click(()=>{
    if(state === "paused") {
        $("#stepbystep").html("|| 暂停");
        state = "running";
        clock = setInterval(()=>{
            SendDebugRequest("step");
        }, 0);
    }
    else if(state === "running") {
        pause();
    }
});

$("#reset").click(()=>{
    pause();
    SendDebugRequest("reset");
});

document.onkeydown = (event)=>{
    if(event && event.keyCode === 121){ // F10
        pause();
        SendDebugRequest("step");
    }
}; 

</script>

</body>
</html>
